<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom Timer</title>
    
    <!-- Web App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Timer">
    
    <link rel="icon" id="favicon">
    <link rel="apple-touch-icon" id="apple-icon">

    <!-- DSEG Font (Digital Clock Font) via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dseg@0.46.0/css/dseg.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50:  'rgb(var(--brand-rgb) / 0.05)',
                            100: 'rgb(var(--brand-rgb) / 0.1)',
                            200: 'rgb(var(--brand-rgb) / 0.2)',
                            300: 'rgb(var(--brand-rgb) / 0.3)',
                            400: 'rgb(var(--brand-rgb) / 0.6)',
                            500: 'rgb(var(--brand-rgb) / 1)',
                            600: 'rgb(var(--brand-rgb) / 0.9)',
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        dseg: ['"DSEG7 Classic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --brand-rgb: 90 156 181; 
        }

        body {
            font-family: 'Outfit', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tabular-nums {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* DSEGフォント調整 */
        .font-dseg {
            font-family: 'DSEG7 Classic', sans-serif;
            font-weight: 700;
            font-style: normal;
        }

        /* 全画面モード制御 */
        body.is-fullscreen .hide-in-fullscreen,
        body.fake-fullscreen .hide-in-fullscreen {
            display: none !important;
        }

        .show-in-fullscreen {
            display: none !important;
        }
        body.is-fullscreen .show-in-fullscreen,
        body.fake-fullscreen .show-in-fullscreen {
            display: flex !important;
        }

        body.is-fullscreen #time-display,
        body.fake-fullscreen #time-display {
            cursor: pointer;
        }

        body.is-fullscreen #main-display,
        body.fake-fullscreen #main-display {
            height: 100vh;
            width: 100vw;
            justify-content: center;
        }

        body.fake-fullscreen #main-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: inherit;
            z-index: 9999;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .soft-shadow {
            box-shadow: 0 4px 20px rgb(var(--brand-rgb) / 0.2);
        }
        
        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid rgba(0,0,0,0.1);
        }
        .color-dot:hover {
            transform: scale(1.1);
        }
        .color-dot.active {
            border-color: #334155;
            transform: scale(1.15);
            box-shadow: 0 0 0 2px rgba(255,255,255,1), 0 0 0 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-white text-slate-800 transition-colors duration-300 min-h-screen flex flex-col overflow-hidden" id="app-body" onclick="stopAlarmIfRinging()">

    <!-- Audio Players (Hidden) -->
    <audio id="bgm-player" loop></audio>
    <audio id="alarm-player" loop></audio> <!-- Loop alarm for 5 sec duration control -->

    <!-- Header Controls -->
    <header class="p-4 flex flex-col sm:flex-row justify-between items-center gap-3 relative z-20 hide-in-fullscreen">
        <!-- Mode Tabs -->
        <div class="flex gap-1 bg-slate-100 rounded-2xl p-1.5 border border-slate-200" id="mode-container">
            <button id="btn-mode-timer" onclick="setMode('timer')" class="flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-bold text-sm bg-brand-500 text-white shadow-lg">
                <i data-lucide="timer" class="w-4 h-4"></i> Timer
            </button>
            <button id="btn-mode-stopwatch" onclick="setMode('stopwatch')" class="flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-bold text-sm text-slate-500 hover:text-brand-600 hover:bg-white">
                <i data-lucide="clock" class="w-4 h-4"></i> Count Up
            </button>
            <button id="btn-mode-clock" onclick="setMode('clock')" class="flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-bold text-sm text-slate-500 hover:text-brand-600 hover:bg-white">
                <i data-lucide="watch" class="w-4 h-4"></i> Clock
            </button>
        </div>

        <!-- Right Side Settings -->
        <div class="flex gap-2 items-center bg-slate-100 p-2 rounded-2xl border border-slate-200 flex-wrap justify-center" id="settings-container">
            
            <!-- BGM Select -->
            <div class="relative group mx-1">
                <select id="bgm-select" class="appearance-none bg-transparent pl-2 pr-6 py-1 text-xs font-bold focus:outline-none cursor-pointer text-center text-slate-600 hover:text-brand-600 uppercase tracking-wider max-w-[80px] sm:max-w-none" title="Select BGM">
                    <option value="">Off</option>
                    <option value="Chill.mp3">Chill</option>
                    <option value="Happy.mp3">Happy</option>
                    <option value="Pop.mp3">Pop</option>
                    <option value="Slow.mp3">Slow</option>
                    <option value="Timer.mp3">Timer</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-1">
                    <i data-lucide="music" class="w-3 h-3 text-brand-500"></i>
                </div>
            </div>

            <div class="w-px h-5 bg-slate-300 mx-1"></div>

            <!-- Alarm Sound Select (File Based) -->
            <div class="relative group mx-1">
                <select id="sound-select" class="appearance-none bg-transparent pl-2 pr-6 py-1 text-xs font-bold focus:outline-none cursor-pointer text-center text-slate-600 hover:text-brand-600 uppercase tracking-wider max-w-[80px] sm:max-w-none" title="Select Alarm Sound">
                    <option value="">Off</option>
                    <option value="Alarm.mp3" selected>Alarm</option>
                    <option value="High.mp3">High</option>
                    <option value="Up.mp3">Up</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-1">
                    <i data-lucide="bell" class="w-3 h-3 text-slate-400"></i>
                </div>
            </div>

            <div class="w-px h-5 bg-slate-300 mx-1"></div>

            <div class="relative group">
                <button onclick="toggleColorMenu(event)" class="p-2 rounded-xl hover:bg-white hover:text-brand-500 transition-all text-slate-500" title="Theme Color">
                    <i id="icon-palette" data-lucide="palette" class="w-4 h-4"></i>
                </button>
                <div id="color-menu" class="absolute top-full right-0 mt-2 p-3 bg-white rounded-xl shadow-xl border border-slate-100 flex gap-2 hidden z-50 min-w-[200px] flex-wrap justify-center">
                </div>
            </div>

            <button onclick="toggleVisual()" class="p-2 rounded-xl hover:bg-white hover:text-brand-500 transition-all text-slate-500" title="Toggle Visual Style">
                <i id="icon-visual" data-lucide="minus" class="w-4 h-4"></i>
            </button>

            <button onclick="toggleTheme()" class="p-2 rounded-xl hover:bg-white hover:text-orange-500 transition-all text-slate-500" id="btn-theme" title="Toggle Dark/Light">
                <i id="icon-theme" data-lucide="moon" class="w-4 h-4"></i>
            </button>
            
            <div class="w-px h-5 bg-slate-300 mx-1"></div>

            <button onclick="toggleFullscreen()" class="p-2 rounded-xl hover:bg-white hover:text-brand-500 transition-all text-slate-500" title="Enter Fullscreen">
                <i id="icon-fullscreen" data-lucide="maximize" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- Main Display Area -->
    <main id="main-display" class="flex-1 flex flex-col items-center justify-center relative w-full h-full">
        
        <!-- Visuals (Ring) -->
        <div id="visual-ring" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-500">
            <svg class="w-[85vmin] h-[85vmin] transform -rotate-90 drop-shadow-xl" viewBox="0 0 100 100">
                <circle id="ring-bg" cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="8" class="opacity-50"></circle>
                <circle id="ring-progress" cx="50" cy="50" r="42" fill="none" stroke="rgb(var(--brand-rgb))" stroke-width="8" 
                        stroke-dasharray="263.89" stroke-dashoffset="0" stroke-linecap="round"
                        class="transition-all duration-1000 ease-linear"></circle>
            </svg>
        </div>

        <!-- Visuals (Bar) -->
        <div id="visual-bar" class="absolute top-0 left-0 w-full h-4 bg-slate-100">
            <div id="bar-progress" class="h-full bg-brand-500 shadow-lg transition-all duration-1000 ease-linear" style="width: 100%;"></div>
        </div>

        <!-- Time Display Container -->
        <div id="time-display" onclick="handleTimeClick()" class="relative z-10 font-extrabold tabular-nums leading-none select-none transition-all duration-200 cursor-default text-slate-800 flex items-end justify-center" 
             style="font-size: clamp(6rem, 28vw, 24rem);">
            <span>05</span><span class="relative -top-[5%] pb-2 mx-[-0.05em]">:</span><span>00</span>
        </div>

        <!-- Exit Fullscreen Button -->
        <button onclick="toggleFullscreen()" class="show-in-fullscreen fixed bottom-8 right-8 p-4 bg-brand-500/10 hover:bg-brand-500/20 text-brand-600 rounded-full backdrop-blur-md transition-all z-50 items-center justify-center group" title="Exit Fullscreen">
            <i data-lucide="minimize" class="w-8 h-8 opacity-70 group-hover:opacity-100 transition-opacity"></i>
        </button>

        <!-- Control Buttons Area -->
        <div id="controls-area" class="flex flex-col items-center gap-8 mt-6 z-20 hide-in-fullscreen w-full max-w-5xl px-4">
            
            <!-- Play/Pause & Reset -->
            <div id="play-reset-buttons" class="flex items-center gap-6">
                <button id="btn-toggle" onclick="toggleTimer()" class="group relative p-6 rounded-full soft-shadow transform active:scale-95 transition-all duration-200 flex items-center justify-center bg-amber-400 hover:bg-amber-500 text-white ring-4 ring-transparent hover:ring-amber-200">
                    <div id="icon-play-wrapper" class="flex items-center justify-center">
                        <i data-lucide="play" class="w-12 h-12 ml-1 fill-current group-hover:scale-110 transition-transform"></i>
                    </div>
                    <div id="icon-pause-wrapper" class="hidden flex items-center justify-center">
                        <i data-lucide="pause" class="w-12 h-12 fill-current"></i>
                    </div>
                </button>

                <button onclick="resetTimer()" class="p-6 rounded-full shadow-md transform active:scale-95 transition-all duration-200 flex items-center justify-center bg-white hover:bg-slate-50 text-slate-400 border border-slate-200 hover:text-slate-600">
                    <i data-lucide="rotate-ccw" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Single Row Quick Settings (Timer only) -->
            <div id="timer-controls" class="w-full animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="w-full overflow-x-auto no-scrollbar pb-4">
                    <div class="flex justify-center min-w-max gap-4 px-4">
                        
                        <!-- +Add Time Group -->
                        <div class="flex gap-2 p-2 bg-slate-50 rounded-2xl border border-slate-100" id="quick-group">
                             <button onclick="addTime(-1)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">-1s</button>
                             <button onclick="addTime(1)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">+1s</button>
                            <button onclick="addTime(10)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">+10s</button>
                            <button onclick="addTime(30)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">+30s</button>
                            <button onclick="addTime(60)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">+1m</button>
                            <button onclick="addTime(300)" class="quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm">+5m</button>
                        </div>

                        <!-- Divider -->
                        <div class="w-px bg-slate-200 mx-1 my-2"></div>

                        <!-- Presets Group -->
                        <div class="flex gap-2 p-2 bg-slate-50 rounded-2xl border border-slate-100" id="preset-group">
                            <button onclick="setPreset(0)" class="preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm">0:00</button>
                            <button onclick="setPreset(60)" class="preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm">1:00</button>
                            <button onclick="setPreset(180)" class="preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm">3:00</button>
                            <button onclick="setPreset(300)" class="preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm">5:00</button>
                            <button onclick="setPreset(600)" class="preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm">10:00</button>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- App Logic -->
    <script>
        const colors = [
            { hex: '#5A9CB5', rgb: '90 156 181' },   // Blue
            { hex: '#FACE68', rgb: '250 206 104' },  // Yellow
            { hex: '#FAAC68', rgb: '250 172 104' },  // Orange
            { hex: '#FA6868', rgb: '250 104 104' },  // Red
            { hex: '#DDAED3', rgb: '221 174 211' }   // Lavender
        ];

        const state = {
            theme: 'light',
            visualType: 'bar',
            mode: 'timer', 
            soundType: 'Alarm.mp3', // Default file
            timeLeft: 300,
            initialTime: 300,
            countUpTime: 0, 
            stopwatchStartTime: 0,
            isActive: false,
            interval: null,
            currentColor: colors[0],
            isAlarmRinging: false,
            selectedBgm: "" 
        };

        let els = {}; 

        window.onload = () => {
            els = {
                body: document.getElementById('app-body'),
                modeContainer: document.getElementById('mode-container'),
                settingsContainer: document.getElementById('settings-container'),
                quickGroup: document.getElementById('quick-group'),
                presetGroup: document.getElementById('preset-group'),
                timeDisplay: document.getElementById('time-display'),
                visualBar: document.getElementById('visual-bar'),
                visualRing: document.getElementById('visual-ring'),
                barProgress: document.getElementById('bar-progress'),
                ringProgress: document.getElementById('ring-progress'),
                ringBg: document.getElementById('ring-bg'),
                timerControls: document.getElementById('timer-controls'),
                playResetButtons: document.getElementById('play-reset-buttons'),
                controlsArea: document.getElementById('controls-area'),
                btnToggle: document.getElementById('btn-toggle'),
                iconPlayWrapper: document.getElementById('icon-play-wrapper'),
                iconPauseWrapper: document.getElementById('icon-pause-wrapper'),
                btnTheme: document.getElementById('btn-theme'),
                iconTheme: document.getElementById('icon-theme'),
                iconVisual: document.getElementById('icon-visual'),
                soundSelect: document.getElementById('sound-select'),
                bgmSelect: document.getElementById('bgm-select'), 
                quickBtns: document.querySelectorAll('.quick-btn'),
                presetBtns: document.querySelectorAll('.preset-btn'),
                colorMenu: document.getElementById('color-menu'),
                bgmPlayer: document.getElementById('bgm-player'),
                alarmPlayer: document.getElementById('alarm-player')
            };

            generateAppIcons(); 
            renderColorMenu();
            lucide.createIcons();
            
            // Event Listeners
            els.soundSelect.addEventListener('change', (e) => {
                state.soundType = e.target.value;
            });
            
            // BGM Listener
            els.bgmSelect.addEventListener('change', (e) => {
                state.selectedBgm = e.target.value;
                updateBgm();
            });

            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            
            setInterval(() => {
                if (state.mode === 'clock') updateDisplay();
            }, 1000);

            applyThemeStyle();
            setMode('timer'); 
        };

        function generateAppIcons() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = state.currentColor.hex;
            ctx.beginPath();
            if (ctx.roundRect) ctx.roundRect(0, 0, 512, 512, 120);
            else ctx.rect(0, 0, 512, 512); 
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 40;
            ctx.beginPath();
            ctx.arc(256, 256, 160, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(256, 156);
            ctx.lineTo(256, 256);
            ctx.lineTo(326, 326);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            const dataUrl = canvas.toDataURL('image/png');
            const favicon = document.getElementById('favicon');
            const appleIcon = document.getElementById('apple-icon');
            if(favicon) favicon.href = dataUrl;
            if(appleIcon) appleIcon.href = dataUrl;
        }

        // --- BGM Logic (With Fade Out) ---
        function updateBgm() {
            const player = els.bgmPlayer;
            
            if (!state.selectedBgm) {
                player.pause();
                return;
            }

            if (player.getAttribute('src') !== state.selectedBgm) {
                player.src = state.selectedBgm;
                player.volume = 1.0; // Reset volume on change
            }

            let shouldPlay = false;

            if (state.mode === 'clock') {
                shouldPlay = true;
                player.volume = 1.0; // Ensure full volume in clock mode
            } else {
                if (state.isActive && !state.isAlarmRinging) {
                    shouldPlay = true;
                    // Reset volume if not fading out (handled in tick)
                    if (state.timeLeft > 4) player.volume = 1.0; 
                }
            }

            if (shouldPlay) {
                if (player.paused) {
                    player.play().catch(e => console.log('Playback prevented:', e));
                }
            } else {
                player.pause();
            }
        }

        function renderColorMenu() {
            if (!els.colorMenu) return;
            els.colorMenu.innerHTML = '';
            
            let currentPalette = [...colors];
            
            if (state.mode === 'clock' && state.theme === 'dark') {
                currentPalette.push({ hex: '#ffffff', rgb: '255 255 255' });
            }

            currentPalette.forEach((c) => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${c.hex === state.currentColor.hex ? 'active' : ''}`;
                dot.style.backgroundColor = c.hex;
                
                if (c.hex === '#ffffff') {
                    dot.style.border = '2px solid #555';
                }

                dot.onclick = (e) => {
                    e.stopPropagation();
                    setColor(c);
                };
                els.colorMenu.appendChild(dot);
            });
        }

        function toggleColorMenu(e) {
            if(e) e.stopPropagation();
            els.colorMenu.classList.toggle('hidden');
        }
        
        document.addEventListener('click', (e) => {
            if (els.colorMenu && !els.colorMenu.classList.contains('hidden') && !e.target.closest('#settings-container')) {
                els.colorMenu.classList.add('hidden');
            }
        });

        function setColor(colorObj) {
            state.currentColor = colorObj;
            document.documentElement.style.setProperty('--brand-rgb', state.currentColor.rgb);
            renderColorMenu();
            els.colorMenu.classList.add('hidden');
            generateAppIcons();
            applyThemeStyle();
            updateDisplay();
        }

        function handleFullscreenChange() {
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                document.body.classList.add('is-fullscreen');
            } else {
                document.body.classList.remove('is-fullscreen');
            }
        }

        function handleTimeClick() {
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.body.classList.contains('fake-fullscreen');
            
            if (isFullscreen && state.mode !== 'clock') {
                toggleTimer();
            }
        }

        function toggleTimer() {
            if (state.mode === 'clock') return;
            
            state.isActive = !state.isActive;
            updatePlayButton();
            updateBgm(); 
            
            if (state.isActive) {
                if (state.mode === 'stopwatch') {
                    const now = Date.now();
                    state.stopwatchStartTime = now - state.countUpTime;
                    state.interval = setInterval(tickStopwatch, 33); 
                } else {
                    state.interval = setInterval(tick, 1000);
                }
            } else {
                clearInterval(state.interval);
            }
        }

        function tick() {
            // Timer Logic
            if (state.timeLeft <= 0) {
                state.timeLeft = 0;
                state.isActive = false;
                clearInterval(state.interval);
                updatePlayButton();
                
                // Stop BGM immediately at end (or ensure it's volume 0)
                if (els.bgmPlayer) els.bgmPlayer.pause();
                
                playAlarmLoop(); 
            } else {
                state.timeLeft--;
                
                // --- Fade Out Logic ---
                if (state.selectedBgm && els.bgmPlayer) {
                     if (state.timeLeft <= 4 && state.timeLeft > 0) {
                         // Fade out: 4s->0.75, 3s->0.5, 2s->0.25, 1s->0
                         // Slightly smoother: volume = time / 5
                         els.bgmPlayer.volume = state.timeLeft / 5;
                     } else if (state.timeLeft > 4) {
                         els.bgmPlayer.volume = 1.0;
                     }
                }
            }
            updateDisplay();
        }

        function tickStopwatch() {
            const now = Date.now();
            state.countUpTime = now - state.stopwatchStartTime;
            updateDisplay();
        }

        let alarmLoopInterval;

        function playAlarmLoop() {
            const type = state.soundType;
            if (!type) {
                // If OFF, just flash
                state.isAlarmRinging = true;
                startFlashing();
                // Auto stop flashing after 5s if no sound
                alarmLoopInterval = setTimeout(() => {
                     stopAlarmIfRinging();
                }, 5000);
                return;
            }

            state.isAlarmRinging = true;
            startFlashing();
            
            // Set source and play
            els.alarmPlayer.src = type;
            els.alarmPlayer.volume = 1.0;
            els.alarmPlayer.play().catch(e => console.log(e));
            
            // Stop after 5 seconds
            alarmLoopInterval = setTimeout(() => {
                stopAlarmIfRinging();
            }, 5000);
        }

        function stopAlarmIfRinging() {
            if (state.isAlarmRinging) {
                state.isAlarmRinging = false;
                clearTimeout(alarmLoopInterval); // Clear the timeout
                els.alarmPlayer.pause();
                els.alarmPlayer.currentTime = 0;
                
                stopFlashing();
                els.timeDisplay.classList.remove('text-red-500', 'animate-pulse');
                
                // Restore BGM volume if it was faded out
                if (els.bgmPlayer) els.bgmPlayer.volume = 1.0;
                updateBgm(); 
                updateDisplay();
            }
        }

        let flashInterval;
        function startFlashing() {
            if (flashInterval) clearInterval(flashInterval);
            
            flashInterval = setInterval(() => {
                if (!state.isAlarmRinging) {
                    stopFlashing();
                    return;
                }
                // Text Flash Logic (handled in updateDisplay mostly, but can toggle here)
                els.timeDisplay.classList.toggle('opacity-50');
            }, 250);
        }

        function stopFlashing() {
            clearInterval(flashInterval);
            els.timeDisplay.classList.remove('opacity-50');
            applyThemeStyle();
        }

        function resetTimer() {
            state.isActive = false;
            clearInterval(state.interval);
            stopAlarmIfRinging();
            updatePlayButton();
            
            // Reset BGM volume
            if (els.bgmPlayer) {
                els.bgmPlayer.volume = 1.0;
                els.bgmPlayer.pause(); // Reset stops BGM
            }
            
            if (state.mode === 'timer') {
                state.timeLeft = state.initialTime;
            } else {
                state.countUpTime = 0;
            }
            els.timeDisplay.classList.remove('text-red-500', 'animate-pulse');
            updateDisplay();
        }

        function addTime(seconds) {
            if (state.mode !== 'timer') return;
            state.timeLeft += seconds;
            if (state.timeLeft < 0) state.timeLeft = 0; 
            if (state.timeLeft > state.initialTime) {
                state.initialTime = state.timeLeft;
            }
            updateDisplay();
        }

        function setPreset(seconds) {
            state.isActive = false;
            clearInterval(state.interval);
            stopAlarmIfRinging();
            state.timeLeft = seconds;
            state.initialTime = Math.max(1, seconds);
            updatePlayButton();
            if (els.bgmPlayer) {
                 els.bgmPlayer.volume = 1.0;
                 els.bgmPlayer.pause();
            }
            updateDisplay();
        }

        function setMode(mode) {
            state.mode = mode;
            state.isActive = false;
            clearInterval(state.interval);
            stopAlarmIfRinging();
            updatePlayButton();
            
            ['btn-mode-timer', 'btn-mode-stopwatch', 'btn-mode-clock'].forEach(id => {
                const btn = document.getElementById(id);
                if (!btn) return;
                if (id === `btn-mode-${mode}`) {
                    btn.className = `flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-bold text-sm bg-brand-500 text-white shadow-lg`;
                } else {
                    btn.className = `flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-bold text-sm ${state.theme === 'dark' ? 'text-slate-400 hover:text-white hover:bg-slate-800' : 'text-slate-500 hover:text-brand-600 hover:bg-white'}`;
                }
            });

            if (mode === 'timer') {
                els.timerControls.classList.remove('hidden');
                els.playResetButtons.classList.remove('hidden');
                els.visualRing.style.opacity = '1';
            } else if (mode === 'stopwatch') {
                els.timerControls.classList.add('hidden');
                els.playResetButtons.classList.remove('hidden');
                els.visualRing.style.opacity = '1';
            } else if (mode === 'clock') {
                els.timerControls.classList.add('hidden');
                els.playResetButtons.classList.add('hidden');
            }

            renderColorMenu();
            updateBgm(); 
            updateDisplay();
        }

        function updatePlayButton() {
            if (state.isActive) {
                els.btnToggle.className = "group relative p-6 rounded-full soft-shadow transform active:scale-95 transition-all duration-200 flex items-center justify-center bg-amber-400 hover:bg-amber-500 text-white ring-4 ring-transparent hover:ring-amber-200";
                els.iconPlayWrapper.classList.add('hidden');
                els.iconPauseWrapper.classList.remove('hidden');
            } else {
                els.btnToggle.className = "group relative p-6 rounded-full soft-shadow transform active:scale-95 transition-all duration-200 flex items-center justify-center bg-brand-500 hover:bg-brand-400 text-white ring-4 ring-transparent hover:ring-brand-200";
                els.iconPlayWrapper.classList.remove('hidden');
                els.iconPauseWrapper.classList.add('hidden');
            }
        }

        function updateDisplay() {
            const textColorClass = state.theme === 'dark' ? 'text-white' : 'text-slate-800';

            if (state.mode === 'clock') {
                const now = new Date();
                const h = now.getHours();
                const m = now.getMinutes();
                const s = now.getSeconds();
                
                const hStr = h.toString().padStart(2, '0');
                const mStr = m.toString().padStart(2, '0');
                const sStr = s.toString().padStart(2, '0');

                els.barProgress.style.opacity = '0';
                els.visualRing.style.opacity = '0';
                
                els.timeDisplay.className = `relative z-10 font-dseg leading-none select-none transition-colors duration-200 cursor-default flex items-baseline justify-center text-brand-500`;
                els.timeDisplay.style.fontSize = "clamp(5rem, 22vw, 20rem)";

                els.timeDisplay.innerHTML = `
                    <div class="flex items-baseline gap-1 sm:gap-2 px-4">
                        <span>${hStr}:${mStr}</span>
                        <span class="text-[0.4em] opacity-80">${sStr}</span>
                    </div>
                `;
                return;
            } 
            
            // Timer/Stopwatch Mode
            els.barProgress.style.opacity = '1';
            els.visualRing.style.opacity = state.visualType === 'ring' ? '1' : '0';
            
            let fontSizeClass = "clamp(6rem, 28vw, 24rem)";
            
            // Logic split
            if (state.mode === 'stopwatch') {
                 const totalMs = state.countUpTime;
                 const m = Math.floor(totalMs / 60000);
                 const s = Math.floor((totalMs % 60000) / 1000);
                 const ms = Math.floor((totalMs % 1000) / 10); 

                 const mStr = m.toString().padStart(2, '0');
                 const sStr = s.toString().padStart(2, '0');
                 const msStr = ms.toString().padStart(2, '0');

                 fontSizeClass = "clamp(4rem, 20vw, 18rem)";
                 
                 els.timeDisplay.innerHTML = `<span class="tracking-widest">${mStr}</span><span class="relative -top-[5%] pb-2 mx-[-0.05em]">:</span><span class="tracking-widest">${sStr}</span><span class="text-[0.5em] opacity-80 ml-1">.${msStr}</span>`;
            
            } else {
                 const t = state.timeLeft;
                 const m = Math.floor(t / 60);
                 const s = t % 60;
                 
                 const mStr = m.toString().padStart(2, '0');
                 const sStr = s.toString().padStart(2, '0');
                 
                 els.timeDisplay.innerHTML = `<span class="tracking-widest">${mStr}</span><span class="relative -top-[5%] pb-2 mx-[-0.05em]">:</span><span class="tracking-widest">${sStr}</span>`;
            }

            els.timeDisplay.className = `relative z-10 font-extrabold tabular-nums leading-none select-none transition-colors duration-200 cursor-default flex items-center justify-center gap-1 sm:gap-2 ${textColorClass}`;
            els.timeDisplay.style.fontSize = fontSizeClass;

            let pct = 100;
            if (state.mode === 'timer') {
                pct = (state.timeLeft / state.initialTime) * 100;
                pct = Math.max(0, Math.min(100, pct));
            }

            els.barProgress.style.width = `${pct}%`;
            
            const circumference = 263.89; 
            const remaining = circumference * (pct / 100);
            const elapsed = circumference - remaining;
            els.ringProgress.style.strokeDasharray = `${remaining} ${circumference}`;
            els.ringProgress.style.strokeDashoffset = `-${elapsed}`;
            
            if (state.mode === 'timer' && (state.timeLeft <= 0 || state.isAlarmRinging)) {
                 els.timeDisplay.classList.add('text-red-500');
                 els.timeDisplay.classList.remove('text-white', 'text-slate-800', 'text-brand-500');
                 
                 els.barProgress.classList.remove('bg-brand-500');
                 els.barProgress.classList.add('bg-red-500');
                 els.ringProgress.setAttribute('stroke', '#ef4444');
            } else {
                 els.timeDisplay.classList.remove('text-red-500');
                 els.barProgress.classList.remove('bg-red-500');
                 els.barProgress.classList.add('bg-brand-500');
                 els.ringProgress.setAttribute('stroke', 'rgb(var(--brand-rgb))');
            }
        }

        function toggleFullscreen() {
            if (document.body.classList.contains('fake-fullscreen')) {
                document.body.classList.remove('fake-fullscreen');
                return;
            }
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const requestFs = document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen;
                if (requestFs) {
                    requestFs.call(document.documentElement).catch(e => {
                        document.body.classList.add('fake-fullscreen');
                    });
                } else {
                    document.body.classList.add('fake-fullscreen');
                }
            } else {
                const exitFs = document.exitFullscreen || document.webkitExitFullscreen;
                if (exitFs) exitFs.call(document);
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.body.classList.contains('fake-fullscreen')) {
                    document.body.classList.remove('fake-fullscreen');
                } else if (document.fullscreenElement || document.webkitFullscreenElement) {
                    const exitFs = document.exitFullscreen || document.webkitExitFullscreen;
                    if (exitFs) exitFs.call(document);
                }
            }
        });

        function toggleVisual() {
            state.visualType = state.visualType === 'bar' ? 'ring' : 'bar';
            if (state.mode !== 'clock') {
                if (state.visualType === 'bar') {
                    els.visualBar.style.opacity = '1';
                    els.visualRing.style.opacity = '0';
                    els.iconVisual.setAttribute('data-lucide', 'minus');
                } else {
                    els.visualBar.style.opacity = '0';
                    els.visualRing.style.opacity = '1';
                    els.iconVisual.setAttribute('data-lucide', 'loader');
                }
            }
            lucide.createIcons();
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyThemeStyle();
            renderColorMenu();
            updateDisplay();
        }

        function applyThemeStyle() {
            renderColorMenu();

            if (state.theme === 'dark') {
                els.body.classList.replace('bg-white', 'bg-slate-950');
                els.body.classList.replace('text-slate-800', 'text-white');
                
                els.modeContainer.classList.replace('bg-slate-100', 'bg-slate-900');
                els.modeContainer.classList.replace('border-slate-200', 'border-slate-800');
                
                els.settingsContainer.classList.replace('bg-slate-100', 'bg-slate-900');
                els.settingsContainer.classList.replace('border-slate-200', 'border-slate-800');
                
                els.quickGroup.classList.replace('bg-slate-50', 'bg-slate-900');
                els.quickGroup.classList.replace('border-slate-100', 'border-slate-800');
                
                els.presetGroup.classList.replace('bg-slate-50', 'bg-slate-900');
                els.presetGroup.classList.replace('border-slate-100', 'border-slate-800');

                els.iconTheme.setAttribute('data-lucide', 'sun');
                els.btnTheme.classList.replace('text-slate-500', 'text-yellow-400');
                els.btnTheme.classList.replace('hover:text-orange-500', 'hover:text-yellow-200');
                els.btnTheme.classList.replace('hover:bg-white', 'hover:bg-slate-800');

                els.ringBg.setAttribute('stroke', '#1e293b'); 

                els.quickBtns.forEach(b => {
                    b.className = "quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-slate-800 text-brand-400 border border-slate-700 hover:bg-slate-700 hover:text-white transition-all active:scale-95 shadow-sm";
                });
                els.presetBtns.forEach(b => {
                    b.className = "preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700 hover:text-white transition-all active:scale-95 shadow-sm";
                });
                els.colorMenu.className = "absolute top-full right-0 mt-2 p-3 bg-slate-900 rounded-xl shadow-xl border border-slate-800 flex gap-2 hidden z-50 min-w-[200px] flex-wrap justify-center";

            } else {
                els.body.classList.replace('bg-slate-950', 'bg-white');
                els.body.classList.replace('text-white', 'text-slate-800');

                els.modeContainer.classList.replace('bg-slate-900', 'bg-slate-100');
                els.modeContainer.classList.replace('border-slate-800', 'border-slate-200');

                els.settingsContainer.classList.replace('bg-slate-900', 'bg-slate-100');
                els.settingsContainer.classList.replace('border-slate-800', 'border-slate-200');

                els.quickGroup.classList.replace('bg-slate-900', 'bg-slate-50');
                els.quickGroup.classList.replace('border-slate-800', 'border-slate-100');

                els.presetGroup.classList.replace('bg-slate-900', 'bg-slate-50');
                els.presetGroup.classList.replace('border-slate-800', 'border-slate-100');

                els.iconTheme.setAttribute('data-lucide', 'moon');
                els.btnTheme.classList.replace('text-yellow-400', 'text-slate-500');
                els.btnTheme.classList.replace('hover:text-yellow-200', 'hover:text-orange-500');
                els.btnTheme.classList.replace('hover:bg-slate-800', 'hover:bg-white');

                els.ringBg.setAttribute('stroke', '#e2e8f0');

                els.quickBtns.forEach(b => {
                    b.className = "quick-btn px-4 py-3 rounded-xl font-bold text-lg bg-white text-brand-600 border border-slate-100 hover:bg-brand-50 hover:border-brand-200 transition-all active:scale-95 shadow-sm";
                });
                els.presetBtns.forEach(b => {
                    b.className = "preset-btn px-5 py-3 rounded-xl font-bold text-lg bg-white text-slate-500 border border-slate-100 hover:bg-slate-50 hover:text-slate-800 transition-all active:scale-95 shadow-sm";
                });
                els.colorMenu.className = "absolute top-full right-0 mt-2 p-3 bg-white rounded-xl shadow-xl border border-slate-100 flex gap-2 hidden z-50 min-w-[200px] flex-wrap justify-center";
            }
            lucide.createIcons();
            setMode(state.mode); 
        }

        // Toggle Sound function removed (Using Select)

    </script>
</body>
</html>
